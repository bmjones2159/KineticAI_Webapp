<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Workout Timeline - KineticAI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            color: #667eea;
            font-size: 1.5em;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
            margin-bottom: 30px;
        }

        .patient-info h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .patient-stats {
            display: flex;
            gap: 30px;
            margin-top: 10px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        /* Calendar/Timeline View */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-toggle button {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-toggle button.active {
            background: #667eea;
            color: white;
        }

        /* Timeline View */
        .timeline-container {
            position: relative;
            padding: 20px 0;
        }

        .timeline-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #e0e0e0;
            transform: translateX(-50%);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            display: flex;
            align-items: flex-start;
        }

        .timeline-item.left {
            flex-direction: row;
            justify-content: flex-end;
        }

        .timeline-item.right {
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .timeline-content {
            width: 45%;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .timeline-content:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .timeline-content.workout {
            border-left-color: #10b981;
        }

        .timeline-content.appointment {
            border-left-color: #f59e0b;
        }

        .timeline-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #667eea;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .timeline-dot.workout {
            background: #10b981;
            box-shadow: 0 0 0 3px #10b981;
        }

        .timeline-dot.appointment {
            background: #f59e0b;
            box-shadow: 0 0 0 3px #f59e0b;
        }

        .timeline-date {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .timeline-details {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 10px;
        }

        .timeline-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-workout {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-appointment {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-score {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Calendar View */
        .calendar-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h3 {
            color: #333;
            font-size: 1.3em;
        }

        .month-nav {
            display: flex;
            gap: 10px;
        }

        .month-nav button {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .month-nav button:hover {
            background: #f5f5f5;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 10px;
            font-size: 0.9em;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-height: 80px;
        }

        .calendar-day:hover {
            background: #f9fafb;
            border-color: #667eea;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.has-activity {
            background: #ede9fe;
            border-color: #667eea;
        }

        .day-number {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .day-indicators {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }

        .day-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .indicator-workout {
            background: #10b981;
        }

        .indicator-appointment {
            background: #f59e0b;
        }

        /* Detail Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .close-btn {
            font-size: 2em;
            color: #666;
            cursor: pointer;
            border: none;
            background: none;
        }

        .workout-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .detail-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .detail-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .detail-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .video-player {
            width: 100%;
            border-radius: 10px;
            margin: 20px 0;
        }

        .feedback-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .feedback-section textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            min-height: 120px;
            resize: vertical;
        }

        .loading {
            text-align: center;
            padding: 60px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .timeline-content {
                width: 90%;
            }
            
            .timeline-line {
                left: 20px;
            }
            
            .timeline-dot {
                left: 20px;
            }
            
            .calendar-grid {
                gap: 2px;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üìä Patient Workout Timeline</h1>
        <div class="nav-buttons">
            <a href="therapist-patients.html" class="btn btn-primary">‚Üê Back to Patients</a>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- Patient Info Header -->
        <div class="content-section">
            <div class="patient-header">
                <div class="patient-info">
                    <h2 id="patientName">Loading...</h2>
                    <div class="patient-stats">
                        <div class="stat-item">
                            <span class="stat-value" id="totalWorkouts">0</span>
                            <span class="stat-label">Total Workouts</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="avgFormScore">0%</span>
                            <span class="stat-label">Avg Form Score</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="currentStreak">0</span>
                            <span class="stat-label">Day Streak</span>
                        </div>
                    </div>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="scheduleAppointment()">
                        üìÖ Schedule Appointment
                    </button>
                </div>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="content-section">
            <div class="view-toggle">
                <button id="timelineViewBtn" class="active" onclick="switchView('timeline')">
                    üìÖ Timeline View
                </button>
                <button id="calendarViewBtn" onclick="switchView('calendar')">
                    üìÜ Calendar View
                </button>
            </div>

            <!-- Timeline View -->
            <div id="timelineView" class="timeline-container">
                <div class="timeline-line"></div>
                <div id="timelineContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading timeline...</p>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendarView" class="calendar-container" style="display: none;">
                <div class="calendar-header">
                    <h3 id="calendarMonthYear">December 2024</h3>
                    <div class="month-nav">
                        <button onclick="changeMonth(-1)">‚Üê Previous</button>
                        <button onclick="changeMonth(1)">Next ‚Üí</button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <!-- Day headers -->
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>
                    <!-- Days populated by JS -->
                    <div id="calendarDays"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Workout Details</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Schedule Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üìÖ Schedule Appointment</h2>
                <button class="close-btn" onclick="closeAppointmentModal()">√ó</button>
            </div>
            <form onsubmit="submitAppointment(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Date & Time</label>
                    <input type="datetime-local" id="appointmentDateTime" required 
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Type</label>
                    <select id="appointmentType" required 
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="in_person">In-Person Session</option>
                        <option value="virtual">Virtual Session</option>
                        <option value="evaluation">Evaluation</option>
                        <option value="follow_up">Follow-up</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Notes</label>
                    <textarea id="appointmentNotes" rows="3" 
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;"
                        placeholder="Any special notes or preparation needed..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Schedule</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAppointmentModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get('patient_id');
        
        let allActivities = [];
        let currentView = 'timeline';
        let currentMonth = new Date();
        let patientData = null;

        async function loadPatientData() {
            try {
                const token = localStorage.getItem('token');
                
                // Load patient details
                const patientResponse = await fetch(`${API_URL}/api/therapist/patients/${patientId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!patientResponse.ok) throw new Error('Failed to load patient');
                
                patientData = await patientResponse.json();
                document.getElementById('patientName').textContent = patientData.full_name || patientData.username;
                
                // Load workouts
                const workoutsResponse = await fetch(`${API_URL}/api/therapist/patients/${patientId}/workouts?limit=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const workoutsData = await workoutsResponse.json();
                
                // Update stats
                document.getElementById('totalWorkouts').textContent = workoutsData.summary.total_workouts || 0;
                document.getElementById('avgFormScore').textContent = `${workoutsData.summary.avg_form_score || 0}%`;
                document.getElementById('currentStreak').textContent = workoutsData.summary.current_streak || 0;
                
                // Combine workouts and appointments into timeline
                allActivities = [];
                
                // Add workouts
                if (workoutsData.workouts) {
                    workoutsData.workouts.forEach(w => {
                        allActivities.push({
                            type: 'workout',
                            date: new Date(w.workout_date || w.completed_at),
                            data: w
                        });
                    });
                }
                
                // TODO: Add appointments from backend
                // For now, you can add mock appointments or fetch from a new endpoint
                
                // Sort by date (newest first)
                allActivities.sort((a, b) => b.date - a.date);
                
                renderTimeline();
                renderCalendar();
                
            } catch (error) {
                console.error('Error loading patient data:', error);
                document.getElementById('timelineContent').innerHTML = 
                    '<p style="color: red; text-align: center;">Failed to load patient data</p>';
            }
        }

        function renderTimeline() {
            const container = document.getElementById('timelineContent');
            
            if (allActivities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No activity yet</p>';
                return;
            }
            
            const html = allActivities.map((activity, index) => {
                const side = index % 2 === 0 ? 'left' : 'right';
                
                if (activity.type === 'workout') {
                    return generateWorkoutTimelineItem(activity, side);
                } else {
                    return generateAppointmentTimelineItem(activity, side);
                }
            }).join('');
            
            container.innerHTML = html;
        }

        function generateWorkoutTimelineItem(activity, side) {
            const w = activity.data;
            const date = new Date(w.workout_date || w.completed_at);
            
            return `
                <div class="timeline-item ${side}">
                    <div class="timeline-dot workout"></div>
                    <div class="timeline-content workout" onclick="viewWorkoutDetails(${w.id})">
                        <div class="timeline-date">
                            <span>üóìÔ∏è ${date.toLocaleDateString()}</span>
                            <span>üïê ${date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        <div class="timeline-title">
                            ${w.exercise_type ? w.exercise_type.toUpperCase() : 'Workout'}
                        </div>
                        <div class="timeline-details">
                            <span class="timeline-badge badge-workout">Workout</span>
                            ${w.reps_completed ? `<span class="timeline-badge badge-score">${w.reps_completed} reps</span>` : ''}
                            ${w.form_score ? `<span class="timeline-badge badge-score">${w.form_score}% form</span>` : ''}
                        </div>
                        ${w.notes ? `<div style="font-size: 0.9em; color: #666; margin-top: 8px;">"${w.notes}"</div>` : ''}
                    </div>
                </div>
            `;
        }

        function generateAppointmentTimelineItem(activity, side) {
            const apt = activity.data;
            const date = new Date(apt.scheduled_time);
            
            return `
                <div class="timeline-item ${side}">
                    <div class="timeline-dot appointment"></div>
                    <div class="timeline-content appointment" onclick="viewAppointmentDetails(${apt.id})">
                        <div class="timeline-date">
                            <span>üóìÔ∏è ${date.toLocaleDateString()}</span>
                            <span>üïê ${date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        <div class="timeline-title">
                            ${apt.type ? apt.type.replace('_', ' ').toUpperCase() : 'Appointment'}
                        </div>
                        <div class="timeline-details">
                            <span class="timeline-badge badge-appointment">Appointment</span>
                            <span class="timeline-badge">${apt.status || 'Scheduled'}</span>
                        </div>
                        ${apt.notes ? `<div style="font-size: 0.9em; color: #666; margin-top: 8px;">"${apt.notes}"</div>` : ''}
                    </div>
                </div>
            `;
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            document.getElementById('calendarMonthYear').textContent = 
                `${currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            let html = '';
            
            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month"><div class="day-number">${daysInPrevMonth - i}</div></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const activities = getActivitiesForDate(date);
                const hasActivity = activities.length > 0;
                
                html += `
                    <div class="calendar-day ${hasActivity ? 'has-activity' : ''}" 
                        onclick="viewDayActivities('${date.toISOString().split('T')[0]}')">
                        <div class="day-number">${day}</div>
                        <div class="day-indicators">
                            ${activities.map(a => `
                                <div class="day-indicator indicator-${a.type}"></div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Next month days
            const totalCells = firstDay + daysInMonth;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let i = 1; i <= remainingCells; i++) {
                    html += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
                }
            }
            
            document.getElementById('calendarDays').innerHTML = html;
        }

        function getActivitiesForDate(date) {
            const dateStr = date.toISOString().split('T')[0];
            return allActivities.filter(a => {
                const activityDate = a.date.toISOString().split('T')[0];
                return activityDate === dateStr;
            });
        }

        function changeMonth(direction) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + direction, 1);
            renderCalendar();
        }

        function switchView(view) {
            currentView = view;
            
            document.getElementById('timelineViewBtn').classList.toggle('active', view === 'timeline');
            document.getElementById('calendarViewBtn').classList.toggle('active', view === 'calendar');
            
            document.getElementById('timelineView').style.display = view === 'timeline' ? 'block' : 'none';
            document.getElementById('calendarView').style.display = view === 'calendar' ? 'block' : 'none';
        }

        async function viewWorkoutDetails(workoutId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/workouts/${workoutId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load workout');
                
                const workout = await response.json();
                displayWorkoutModal(workout);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load workout details');
            }
        }

        function displayWorkoutModal(workout) {
            document.getElementById('modalTitle').textContent = 
                `${workout.exercise_type ? workout.exercise_type.toUpperCase() : 'Workout'} - ${new Date(workout.workout_date).toLocaleDateString()}`;
            
            let content = `
                <div class="workout-details-grid">
                    <div class="detail-card">
                        <div class="detail-value">${workout.reps_completed || 0}</div>
                        <div class="detail-label">Reps</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-value">${workout.sets_completed || 0}</div>
                        <div class="detail-label">Sets</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-value">${workout.form_score || 0}%</div>
                        <div class="detail-label">Form Score</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-value">${workout.duration_seconds ? Math.floor(workout.duration_seconds / 60) + ':' + String(workout.duration_seconds % 60).padStart(2, '0') : '-'}</div>
                        <div class="detail-label">Duration</div>
                    </div>
                </div>
            `;
            
            if (workout.video_id) {
                const token = localStorage.getItem('token');
                content += `
                    <video class="video-player" controls>
                        <source src="${API_URL}/api/video-stream/${workout.video_id}?token=${token}" type="video/mp4">
                    </video>
                `;
            }
            
            if (workout.notes) {
                content += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Patient Notes:</strong>
                        <p style="margin: 8px 0 0 0;">${workout.notes}</p>
                    </div>
                `;
            }
            
            content += `
                <div class="feedback-section">
                    <h3 style="margin-bottom: 15px;">Add Feedback</h3>
                    <textarea id="feedbackText" placeholder="Enter your feedback for this workout..."></textarea>
                    <button class="btn btn-primary" onclick="submitFeedback(${workout.id})" 
                        style="margin-top: 15px; width: 100%;">
                        Submit Feedback
                    </button>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').classList.add('active');
        }

        async function submitFeedback(workoutId) {
            const feedback = document.getElementById('feedbackText').value;
            
            if (!feedback.trim()) {
                alert('Please enter feedback');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/therapist/workouts/${workoutId}/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        feedback: feedback
                    })
                });
                
                if (!response.ok) throw new Error('Failed to submit feedback');
                
                alert('‚úì Feedback submitted successfully!');
                closeModal();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to submit feedback');
            }
        }

        function viewDayActivities(dateStr) {
            const date = new Date(dateStr);
            const activities = getActivitiesForDate(date);
            
            if (activities.length === 0) {
                return;
            }
            
            document.getElementById('modalTitle').textContent = 
                `Activities for ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            
            const content = activities.map(activity => {
                if (activity.type === 'workout') {
                    const w = activity.data;
                    return `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; cursor: pointer;"
                            onclick="viewWorkoutDetails(${w.id})">
                            <h3 style="color: #10b981; margin-bottom: 10px;">
                                üèãÔ∏è ${w.exercise_type ? w.exercise_type.toUpperCase() : 'Workout'}
                            </h3>
                            <div style="display: flex; gap: 20px;">
                                <span>Reps: ${w.reps_completed || 0}</span>
                                <span>Form: ${w.form_score || 0}%</span>
                            </div>
                        </div>
                    `;
                } else {
                    const apt = activity.data;
                    return `
                        <div style="background: #fef3c7; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                            <h3 style="color: #92400e; margin-bottom: 10px;">
                                üìÖ ${apt.type ? apt.type.replace('_', ' ').toUpperCase() : 'Appointment'}
                            </h3>
                            <div>${new Date(apt.scheduled_time).toLocaleTimeString()}</div>
                        </div>
                    `;
                }
            }).join('');
            
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').classList.add('active');
        }

        function scheduleAppointment() {
            document.getElementById('appointmentModal').classList.add('active');
        }

        function closeAppointmentModal() {
            document.getElementById('appointmentModal').classList.remove('active');
        }

        async function submitAppointment(event) {
            event.preventDefault();
            
            const appointmentData = {
                patient_id: patientId,
                scheduled_time: document.getElementById('appointmentDateTime').value,
                type: document.getElementById('appointmentType').value,
                notes: document.getElementById('appointmentNotes').value
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/therapist/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(appointmentData)
                });
                
                if (!response.ok) throw new Error('Failed to schedule appointment');
                
                alert('‚úì Appointment scheduled successfully!');
                closeAppointmentModal();
                loadPatientData(); // Reload to show new appointment
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to schedule appointment');
            }
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            window.location.href = 'index.html';
        }

        // Initialize
        if (!patientId) {
            alert('No patient selected');
            window.location.href = 'therapist-patients.html';
        } else {
            loadPatientData();
        }
    </script>
</body>
</html>
